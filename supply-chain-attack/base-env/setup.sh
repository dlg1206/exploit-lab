#!/bin/ash
# file: setup.sh
# description: register user in mock npm repository
#
# @author Derek Garcia

# don't set if already done
if [ "$USER_CREATED" -eq 1 ]; then
  exit 0
fi

# generate new uid each item. Conflict possible, but unlikely
uid=$((RANDOM % 101010))

# register new user
token=$(curl -s \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -X PUT --data "{\"name\": \"$uid\", \"password\": \"$uid\"}" \
  "http://$MOCK_REGISTRY/-/user/org.couchdb.user:$uid" | \
  jq -r '.token // empty')

# config to use local register
npm set registry "http://$MOCK_REGISTRY"
npm set "//$MOCK_REGISTRY/:_authToken=$token"

# indicate success
export USER_CREATED=1