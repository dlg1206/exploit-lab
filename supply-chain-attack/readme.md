# Supply Chain Attack Lab

> Self-contained NPM ecosystem to demonstrate a supply chain attack

## Quickstart

1. Create the user base image

```bash
docker build -t base-env base-env
```

This creates the preconfigured environment to users are created from

2. Launch the NPM ecosystem

```bash
docker compose up -d  # -d runs container in detached mode
```

This will launch three containers:

1. `mock-npm`: a self-hosted npm registry using [Verdaccio](https://verdaccio.org/). This is an isolated registry to
   ensure any nasty packages are contained and **not** pushed to npm
2. `alice`: a container representing a downstream victim
3. `mallory`: a container representing an upstream attacker

To stop the contain, use `docker compose stop` to preserve any changes to the database,
otherwise use `docker compose down` to reset to the initial configuration

## Walkthrough

1. Attach to the `mallory` container

On the host machine, run:

```bash
docker exec -it mallory ash
```

Inside there are two directories:

```
total 12
drwxr-xr-x    2 mallory  mallory       4096 Feb 13 06:43 coookie-jar
drwxr-xr-x    1 mallory  mallory       4096 Feb 13 06:43 listen
```

`coookie-jar`: is a typosquatting package with a dummy [hello world js file](mallory/coookie-jar/index.js). The true
payload is inside the [setup-utils.sh](mallory/coookie-jar/setup-utils.sh) script, which attempts to get details about
the host machine

```
...
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "preinstall": "sh setup-utils.sh"   # preinstall will run before package is installed
...  
```

The script will get executed on before the `coookie-jar` package is installed because of the `preinstall` keyword in
the [package.json](mallory/coookie-jar/package.json) file.

2. "Publish" the malicious `coookie-jar` package

Inside the `mallory` container, run:

```bash
npm publish coookie-jar
```

This will publish the package on the isolated npm registry:

```
npm notice
npm notice package: coookie-jar@1.0.0
npm notice Tarball Contents
npm notice 103B index.js
npm notice 277B package.json
npm notice 586B setup-utils.sh
npm notice Tarball Details
npm notice name: coookie-jar
npm notice version: 1.0.0
npm notice filename: coookie-jar-1.0.0.tgz
npm notice package size: 737 B
npm notice unpacked size: 966 B
npm notice shasum: 63df75cae8a02e63ee99df44ba58b150beda6f5d
npm notice integrity: sha512-0bODMorNt08tf[...]GHMGzepk2BJ4g==
npm notice total files: 3
npm notice
npm notice Publishing to http://mock-npm:4873 with tag latest and default access
+ coookie-jar@1.0.
```

_Resulting command output_

3. Launch listening server

Now we wait until someone installs the malicious package. To listen for requests, the [listen](mallory/listen)
package has a util express.js server. To launch it, run:

```bash
node listen/listen.js
```

4. Attaching to `alice` container

In a new terminal window on the host machine, attach to the `alice` container by running:

```bash
docker exec -it alice ash
```

The container will be empty.

5. Install the malicious `coookie-jar` package

Inside the `alice` container, run:

```bash
npm install coookie-jar
```

This will install the malicious package and appear as if the package installed as normal

```
~ $ npm install coookie-jar

added 1 package in 729ms
```

_alice container output_

However, checking the `mallory` container:

```
~ $ node listen/listen.js 
Listening. . .
POST request received at /
Data: {
  "user": "alice",
  "ip_address": "172.18.0.3",
  "distro_details": "NAME=Alpine Linux",
  "my_super_duper_secret": "Hawaii is the only state to grow coffee commercially."
}
```

We can see the attack was a success.

## Development

To develop and test your own malicious packages, you can use the `base-env` image.

1. Create npm package

```bash
mkdir <your-package-name> && cd <your-package-name> && npm init -y
```

This will create a blank npm project

2. Mount container

Make sure the docker compose stack is running!

```bash
docker run --rm -it -v "<absolute-path-to-local-npm-package>:/malpm" --network=supply-chain-attack_sca-net --entrypoint ash base-env -c ". /setup.sh; ash"
```

- `<absolute-path-to-local-npm-package>`: is the absolute path to your package. If you make a test project using the
  previous step, you can use "`$(pwd):/malpm`"
- `--network=supply-chain-attack_sca-net`: attack the docker compose network
- `--entrypoint ash`: open a shell
- `-c ". /setup.sh; ash"`: run the setup script that sets up a npm user, then open a shell

3. Develop you package

On your host machine, develop your package with whatever exploit you wish to try on a victim container. When done,
inside the container run:

```bash
npm publish
```

Then on the `alice` container, run:

```bash
npm install <your-package-name>
```

and monitor the impact.
